<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estadísticas</title>
    <link href="../output.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
</head>

<body class="bg-gradient-to-r from-blue-50 to-indigo-50 min-h-screen flex flex-col">
    <div class="flex-grow">

        <!-- Header con menú móvil -->
        <header class="bg-primary-light text-white flex items-center justify-between px-6 py-4 rounded-b-lg shadow-md">
            <div class="flex items-center space-x-4">
                <img src="../assets/svg/icono.svg" alt="Icono Labofam" class="h-10 w-auto filter invert" />
                <img src="../assets/svg/logo.svg" alt="Labofam" class="h-6 w-auto filter invert" />
            </div>
            <div class="flex items-center space-x-4">
                <!-- Botón hamburguesa visible en móvil -->
                <button id="nav-toggle" class="md:hidden focus:outline-none">
                    <svg class="h-6 w-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                        xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M4 6h16M4 12h16M4 18h16"></path>
                    </svg>
                </button>
                <!-- Navegación de escritorio -->
                <nav class="hidden md:flex space-x-6">
                    <a href="./inicio.html" class="hover:bg-white/20 px-4 py-2 rounded">Inicio</a>
                    <!-- <a href="/reportes.html" class="hover:bg-white/20 px-4 py-2 rounded">Reportes</a> -->
                    <a href="./estadisticas.html" class="hover:bg-white/20 px-4 py-2 rounded">Estadísticas</a>
                </nav>
            </div>
        </header>

        <!-- Menú móvil desplegable -->
        <nav id="mobile-nav" class="bg-primary-light text-white hidden md:hidden">
            <div class="flex flex-col px-6 py-4 space-y-2">
                <a href="./inicio.html" class="block py-2 hover:bg-primary-light/20 rounded">Inicio</a>
                <!--  <a href="/reportes.html" class="block py-2 hover:bg-primary-light/20 rounded">Reportes</a> -->
                <a href="./estadisticas.html" class="block py-2 hover:bg-primary-light/20 rounded">Estadísticas</a>
            </div>
        </nav>
        <div class="p-4  bg-white shadow z-10 sticky top-0 ">
            <div class="flex flex-col sm:flex-row flex-wrap items-center justify-center gap-4">
                <!-- Selector de estudio -->
                <div class="flex items-center gap-2">
                    <label for="estudioSeleccionado" class="font-semibold text-gray-700">Estudio:</label>
                    <select id="estudioSeleccionado"
                        class="border border-gray-300 rounded px-3 py-1 shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-400">
                        <!-- Opciones se llenan con JS -->
                    </select>
                </div>
                <div class="flex items-center gap-2">
                    <label for="rondaSeleccionada" class="font-semibold text-gray-700">Estudio:</label>
                    <select id="rondaSeleccionada"
                        class="border border-gray-300 rounded px-3 py-1 shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-400">
                        <!-- Opciones se llenan con JS -->
                    </select>
                </div>


                <!-- Botón -->
                <button id="filtrarBtn"
                    class="bg-primary-light text-white px-4 py-1 rounded shadow hover:bg-primary-dark transition">
                    Obtener datos
                </button>

            </div>
            <div class="flex flex-col sm:flex-row flex-wrap items-center justify-center gap-4">
                <div id="fechas" class="flex items-center ">

                </div>
            </div>

        </div>

        <div class="flex-1 overflow-y-auto max-h-[calc(100vh-100px)] p-2 space-y-4 ">

            <!-- Carruseles -->
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                <div id="actividadPrincipal1" class="sm:col-span-2 lg:col-span-1">
                    <div
                        class="bg-white p-4 rounded-xl shadow-md flex items-center justify-center h-48 text-gray-400 italic">

                    </div>
                </div>
                <div id="actividadPrincipal2" class="sm:col-span-2 lg:col-span-1">
                    <div
                        class="bg-white p-4 rounded-xl shadow-md flex items-center justify-center h-48 text-gray-400 italic">

                    </div>
                </div>
                <div id="actividadPrincipal3" class="sm:col-span-2 lg:col-span-1">
                    <div
                        class="bg-white p-4 rounded-xl shadow-md flex items-center justify-center h-48 text-gray-400 italic">

                    </div>
                </div>
            </div>

            <!-- Satisfacción -->
            <div class="grid grid-cols-1 gap-4">
                <div id="satisfaccionChart" class="sm:col-span-2 lg:col-span-1">
                    <div
                        class="bg-white p-4 rounded-xl shadow-md flex items-center justify-center h-48 text-gray-400 italic">

                    </div>
                </div>
            </div>

            <!-- Polares -->
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                <div id="actividadPrincipalSatifaccion1" class="sm:col-span-2 lg:col-span-1">
                    <div
                        class="bg-white p-4 rounded-xl shadow-md flex items-center justify-center h-48 text-gray-400 italic">

                    </div>
                </div>
                <div id="actividadPrincipalSatifaccion2" class="sm:col-span-2 lg:col-span-1">
                    <div
                        class="bg-white p-4 rounded-xl shadow-md flex items-center justify-center h-48 text-gray-400 italic">

                    </div>
                </div>
                <div id="actividadPrincipalSatifaccion3" class="sm:col-span-2 lg:col-span-1">
                    <div
                        class="bg-white p-4 rounded-xl shadow-md flex items-center justify-center h-48 text-gray-400 italic">

                    </div>
                </div>
            </div>



        </div>





    </div>

    <!-- Footer -->
    <footer class="bg-primary-light text-white py-2">
        <div class="max-w-6xl mx-auto px-4 flex flex-col items-center">
            <!-- Redes sociales centradas -->
            <div class="flex space-x-6 mb-4">
                <!-- Facebook -->
                <a href="https://facebook.com/labofamchile" aria-label="Facebook" class="hover:text-primary-dark">
                    <svg class="h-8 w-8" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                        <path
                            d="M22 12c0-5.523-4.477-10-10-10S2 6.477 2 12c0 4.991 3.657 9.128 8.438 9.878v-6.99H7.898v-2.888h2.54V9.845c0-2.507 1.492-3.89 3.777-3.89 1.094 0 2.238.195 2.238.195v2.46h-1.26c-1.242 0-1.63.771-1.63 1.562v1.875h2.773l-.443 2.888h-2.33v6.99C18.343 21.128 22 16.991 22 12z" />
                    </svg>
                </a>
                <!-- Twitter -->
                <a href="https://twitter.com/labofamchile" aria-label="Twitter" class="hover:text-primary-dark">
                    <svg class="h-8 w-8" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                        <path
                            d="M23 3a10.9 10.9 0 01-3.14 1.53 4.48 4.48 0 00-7.86 3v1A10.66 10.66 0 013 4s-4 9 5 13a11.64 11.64 0 01-7 2c9 5 20 0 20-11.5a4.5 4.5 0 00-.08-.83A7.72 7.72 0 0023 3z" />
                    </svg>
                </a>
                <!-- Instagram -->
                <a href="https://instagram.com/labofamchile" aria-label="Instagram" class="hover:text-primary-dark">
                    <svg class="h-8 w-8" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                        <path
                            d="M7.75 2h8.5A5.75 5.75 0 0122 7.75v8.5A5.75 5.75 0 0116.25 22h-8.5A5.75 5.75 0 012 16.25v-8.5A5.75 5.75 0 017.75 2zm0 1.5A4.25 4.25 0 003.5 7.75v8.5A4.25 4.25 0 007.75 20.5h8.5a4.25 4.25 0 004.25-4.25v-8.5A4.25 4.25 0 0016.25 3.5h-8.5zm8.75 1a.75.75 0 110 1.5.75.75 0 010-1.5zM12 7a5 5 0 110 10 5 5 0 010-10zm0 1.5a3.5 3.5 0 100 7 3.5 3.5 0 000-7z" />
                    </svg>
                </a>
            </div>
            <!-- Texto copyright abajo -->
            <p class="text-base text-center">
                © 2025 Labofam Chile. Todos los derechos reservados.
            </p>


        </div>
    </footer>

    <script type="module">
        import { showToast } from '../utils/feedback.js';
        import rondasController from '../../controller/rondasController.js';
        import TimelineApi from '../../controller/TimelineController.js';
        let estudios = JSON.parse(localStorage.getItem('estudios')) || [];
        document.getElementById('nav-toggle').addEventListener('click', () => {
            document.getElementById('mobile-nav').classList.toggle('hidden');
        });
        async function getRondasFromDB() {
            try {
                const id_estudio = localStorage.getItem('id_estudio')
                const identificador = localStorage.getItem('identificador')
                const resp = await rondasController.getRondasEstudio(id_estudio, identificador)

                return resp;
            } catch (e) {
                console.error(e);
            }
        }



        let rondasActuales = [];
        let hayRondasFinalizadas = false;
        var rondaSelect = document.getElementById('rondaSeleccionada');
        await getRondasFromDB().then(rondas => {
            rondasActuales = rondas;





            rondasActuales.forEach(ronda => {
                if (ronda.finalizada) {
                    console.log(ronda)
                    const option = document.createElement('option');
                    option.value = JSON.stringify(ronda);
                    option.textContent = `Ronda ${ronda.numero_ronda} - ${ronda.anio} - ${!ronda.dias_semana.includes(6 || 7) ? 'Semana' : 'Finde de semana'}`;
                    rondaSelect.appendChild(option);
                    hayRondasFinalizadas = true;
                }
            });

            if (!hayRondasFinalizadas) {
                const option = document.createElement('option');
                option.textContent = 'No hay rondas finalizadas disponibles';
                option.disabled = true;
                option.selected = true;
                rondaSelect.appendChild(option);
            }

        });

        const hoy = new Date();
        var diasValidos = []

        // Poblar selector de estudios
        var estudioSelect = document.getElementById('estudioSeleccionado');
        estudios.forEach(est => {
            const option = document.createElement('option');
            option.value = JSON.stringify(est);
            option.textContent = est.nombre;
            estudioSelect.appendChild(option);
        });


        // Manejar botón
        var satifaccion = {}
        var principal = {}
        var conquien = {}
        var donde = {}

        document.getElementById('filtrarBtn').addEventListener('click', async () => {
            const btn = document.getElementById('filtrarBtn');
            try {

                btn.disabled = true;
                btn.textContent = 'Cargando...';
                if (!hayRondasFinalizadas) {
                    showToast('error', 'No hay rondas finalizadas disponibles.', 'top-center', 2000);
                    return;
                }

                const estudio = JSON.parse(estudioSelect.value);
                const ronda = JSON.parse(rondaSelect.value);
                if (!estudio || !ronda) {
                    showToast('error', 'Por favor, selecciona un estudio y una fecha.', 'top-center', 2000);
                    return;
                }

                // Lógica para obtener datos según estudio y fecha
                const identificador = localStorage.getItem('identificador')
                const payload = {
                    id_estudio: estudio.id_estudio,
                    identificador: identificador,
                    id_ronda: ronda.id_ronda
                };
                const resp = await TimelineApi.getTimelineRegistros(payload);
                const fechas = document.getElementById('fechas');

                //resetear gráficos
                document.getElementById('actividadPrincipal1').innerHTML = '';
                document.getElementById('actividadPrincipal2').innerHTML = '';
                document.getElementById('actividadPrincipal3').innerHTML = '';
                document.getElementById('satisfaccionChart').innerHTML = '';
                document.getElementById('actividadPrincipalSatifaccion1').innerHTML = '';
                document.getElementById('actividadPrincipalSatifaccion2').innerHTML = '';
                document.getElementById('actividadPrincipalSatifaccion3').innerHTML = '';

                crearCarruselActividades('actividadPrincipal1', agruparPorDimension(resp, "Principal", "minutos"), "Actividad principal");
                crearCarruselActividades('actividadPrincipal2', agruparPorDimension(resp, "compañia", "minutos"), "¿Con quién?");
                crearCarruselActividades('actividadPrincipal3', agruparPorDimension(resp, "ubicación", "minutos"), "¿Dónde?");
                crearGraficoSatisfaccion('satisfaccionChart', resp);
                crearPolarChartActividades('actividadPrincipalSatifaccion1', agruparPorDimension(resp, "Principal", "satisfaccion"), "Satisfacción actividad principal");
                crearPolarChartActividades('actividadPrincipalSatifaccion2', agruparPorDimension(resp, "compañia", "satisfaccion"), "Satisfacción relaciones");
                crearPolarChartActividades('actividadPrincipalSatifaccion3', agruparPorDimension(resp, "ubicación", "satisfaccion"), "Satisfacción lugares");


            } catch (e) {
                showToast('error', 'Error al obtener datos.', 'top-center', 2000);
                console.error(e);
            } finally {
                btn.disabled = false;
                btn.textContent = 'Obtener datos';
            }
        });
        /* // Función para generar colores HSL únicos
        function generarColor(index) {
            const hue = (index * 137.508) % 360; // valor mágico para mejor dispersión
            return `hsl(${hue}, 70%, 60%)`;
        } */

        function agruparPorDimension(actividades, dimension, ordenarPor = 'satisfaccion') {
            const agrupados = new Map();

            actividades.forEach(item => {
                let clave;

                if (item.nombre_dimension === "Principal" && dimension === "Principal") {
                    // Para la dimensión Principal, usar jerarquía de claves
                    clave = 
                        item.valor_numerico 
                        || item.otroValor
                        || item.nombre_actividad
                       
                        || item.nombre_subcategoria
                        || item.nombre_categoria
                        || item.nombre_dimension
                        
                        || "(sin nombre)";
                } else if (dimension !== "Principal") {
                    // Para otras dimensiones, tomar el valor directamente del campo
                    console.log(item)
                    clave = item[dimension] ?? "(sin valor)";
                } else {
                    // Si no corresponde a esta dimensión, saltar
                    return;
                }

                if (!agrupados.has(clave)) {
                    agrupados.set(clave, {
                        nombre: clave,
                        clave: clave,
                        dimension,
                        minutos: 0,
                        sumaPonderada: 0,
                        registros: [],
                        color: item.color ?? "#cccccc"
                    });
                }

                const grupo = agrupados.get(clave);
                grupo.minutos += item.minutos;

                // Usar valor_numerico si existe, sino 0
                const valor = Number(item.satisfacción ?? 0);
                grupo.sumaPonderada += valor * item.minutos;

                grupo.registros.push(item);
            });

            const resultado = Array.from(agrupados.values()).map(grupo => {
                const satisfaccion_promedio = grupo.minutos > 0
                    ? grupo.sumaPonderada / grupo.minutos
                    : 0;
                return {
                    ...grupo,
                    satisfaccion_promedio
                };
            });

            // Ordenar resultado
            console.log(resultado)
            if (ordenarPor === 'minutos') {
                return resultado.sort((a, b) => b.minutos - a.minutos);
            } else {
                return resultado.sort((a, b) => b.satisfaccion_promedio - a.satisfaccion_promedio);
            }
        }




        function formatearAHoras(mins) {
            const horas = Math.floor(mins / 60);
            const minutosRestantes = mins % 60;
            return `${horas}h ${minutosRestantes}m`;
        }


        function crearCarruselActividades(containerId, actividadesAgrupadas, titulo = "Actividad principal") {
            const container = document.getElementById(containerId);




            container.innerHTML = `
                    <div class="bg-white p-4 rounded-xl shadow-md flex flex-col overflow-hidden relative">
                        <h2 class="text-base font-semibold mb-4 text-center">${titulo}</h2>

                        <div class="relative w-full">
                            <button class="prevBtn absolute left-0 top-1/2 -translate-y-1/2 z-10 text-primary-light hover:text-primary-dark px-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none"
                                    viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M15 19l-7-7 7-7" />
                                </svg>
                            </button>

                            <!-- Carrusel centrado -->
                            <div class="mx-10 overflow-hidden  ">
                            <div class="chartCarousel flex space-x-6 transition-all duration-500 overflow-hidden scrollbar-hide justify-between ">

                                <!-- tus gráficos van aquí -->
                            </div>
                            </div>

                            <!-- Botón derecho -->
                            <button class="nextBtn absolute right-0 top-1/2 -translate-y-1/2 z-10 text-primary-light hover:text-primary-dark px-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none"
                                    viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M9 5l7 7-7 7" />
                                </svg>
                            </button>
                        </div>  
                    </div>
                `;

            var carousel = container.querySelector('.chartCarousel');

            actividadesAgrupadas.forEach(({ clave, minutos, nombre, color, bg = '#f3f4f6' }) => {

                const chartDiv = document.createElement('div');
                chartDiv.className = 'flex flex-col items-center w-24 shrink-0 ';
                chartDiv.innerHTML = `
                    <div class="relative w-20 h-20">
                        <canvas id="${clave}"></canvas>
                        <div class="absolute inset-0 flex items-center justify-center text-sm font-semibold text-gray-700">
                            ${formatearAHoras(minutos)}
                        </div>
                    </div>
                    <div class="w-20 mx-auto mt-1 text-center">
                        <p 
                            class="text-sm w-full truncate whitespace-nowrap overflow-hidden text-center"
                            title="${nombre}"
                        >
                            ${nombre}
                        </p>
                    </div>
                `;



                carousel.appendChild(chartDiv);


                new Chart(document.getElementById(clave), {
                    type: 'doughnut',
                    data: {
                        datasets: [{
                            data: [minutos, 1440 - minutos],
                            backgroundColor: [color, bg],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        cutout: '70%',
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: { enabled: false }
                        }
                    }
                });
            });

            // Scroll funcional por botones
            const scrollStep = 100;
            const prevBtn = container.querySelector('.prevBtn');
            const nextBtn = container.querySelector('.nextBtn');

            prevBtn.onclick = () => carousel.scrollBy({ left: -scrollStep, behavior: 'smooth' });
            nextBtn.onclick = () => carousel.scrollBy({ left: scrollStep, behavior: 'smooth' });
            carousel.scrollLeft = 0;
        }

        function calcularSuperposicionDesde(actInicio, actFin, satInicio, satFin) {
            const inicio = Math.max(actInicio, satInicio);
            const fin = Math.min(actFin, satFin);
            if (inicio < fin) {
                return { inicio, fin, minutos: (fin - inicio) / (1000 * 60) };
            }
            return null;
        }

        function dividirActividadEnTramos(actividades, satisfacciones) {
            const resultado = [];

            actividades.forEach(act => {
                const actInicio = new Date(act.hora_inicio).getTime();
                const actFin = new Date(act.hora_termino).getTime();

                satisfacciones.forEach(sat => {
                    const satInicio = new Date(sat.hora_inicio).getTime();
                    const satFin = new Date(sat.hora_termino).getTime();


                    const cruce = calcularSuperposicionDesde(actInicio, actFin, satInicio, satFin);
                    if (cruce) {
                        resultado.push({
                            ...act,
                            hora_inicio: new Date(cruce.inicio).toISOString(),
                            hora_termino: new Date(cruce.fin).toISOString(),
                            minutos: cruce.minutos,
                            valor_satisfaccion: sat.valor_numerico
                        });
                    }
                });
            });

            return resultado;
        }







        function transformarDatosSatisfaccion(actividades) {
            return actividades.flatMap((act) => ([
                { x: new Date(act.hora_inicio), y: act.satisfacción || act.satisfacción, tipo: 'inicio', ...act },
                { x: new Date(act.hora_termino), y: act.satisfacción || act.satisfacción, tipo: 'termino', ...act }
            ]));
        }
        function satifaccionPromedio(actividades) {

            return actividades.reduce((promedio, { satisfacción }) => promedio + satisfacción, 0) / actividades.length;
        }
        function crearPolarChartActividades(containerId, datosAgrupados, titulo = "Actividades con mayor dedicación", tipo = 'minutos') {
            const container = document.getElementById(containerId);
            if (!container) return;


            container.innerHTML = `
                    <div class="bg-white  rounded-xl shadow-md flex flex-col overflow-hidden relative">
                <h2 class="text-base font-semibold  text-center">${titulo}</h2>


                    <div class="bg-white  rounded-xl shadow-md flex flex-col overflow-hidden relative h-60">
            
            <canvas class="absolute  w-full h-full"></canvas>
        </div>
               
                </div>

                `;
            const canvas = container.querySelector('canvas');
            if (!canvas) return;

            const labels = datosAgrupados.map(d => d.nombre);
            const valores = datosAgrupados.map(d => d.satisfaccion_promedio);
            const colores = datosAgrupados.map(d => d.color);

            new Chart(canvas.getContext('2d'), {
                type: 'polarArea',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Satisfacción ponderada',
                        data: valores,
                        backgroundColor: colores,
                        borderWidth: 1,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    layout: {
                        padding: {
                            top: 10,
                            bottom: 10
                        }
                    },
                    plugins: {
                        title: {
                            display: false
                        },
                        legend: {
                            display: true,
                            labels: {

                                font: {
                                    size: 12
                                },



                            },


                            position: 'left'
                        },

                    },
                    scales: {
                        r: {
                            beginAtZero: true,
                            ticks: {
                                precision: 0
                            }
                        }
                    }
                }
            });
        }


        function crearGraficoSatisfaccion(containerId, datos, minFecha = null, maxFecha = null) {




            const container = document.getElementById(containerId);
            if (!container) return;

            container.innerHTML = `
        <div class="bg-white p-4 rounded-xl shadow-md flex flex-col overflow-hidden relative h-60">
            
            <canvas class="absolute inset-0 w-full h-full"></canvas>
        </div>
    `;

            const canvas = container.querySelector('canvas');
            if (!canvas) return;

            var promedio = satifaccionPromedio(datos);

            var datosPrincipal = transformarDatosSatisfaccion(datos);
            console.log(datosPrincipal)
            /* var datosPrincipal = transformarDatosSatisfaccion(actividadesConSatisfaccion); */

            if (!minFecha) minFecha = datosPrincipal[0]?.x;
            if (!maxFecha) maxFecha = datosPrincipal[datos.length - 1]?.x;

            const datosPromedio = [
                { x: minFecha, y: promedio, tipo: 'promedio' },
                { x: maxFecha, y: promedio, tipo: 'promedio' }
            ];

            new Chart(canvas.getContext('2d'), {
                type: 'line',
                data: {
                    datasets: [
                        {
                            label: 'Satisfacción',
                            data: datosPrincipal,
                            parsing: false,
                            borderColor: '#682850',

                            tension: 0.1
                        },

                        {
                            label: 'Satisfacción Promedio',
                            data: datosPromedio,
                            parsing: false,
                            borderColor: '#f59e0b',
                            borderDash: [5, 5],
                            tension: 0.1
                        },/*  {
                            label: 'Principal',
                            data: datosPrincipal,
                            parsing: false,
                            borderColor: '#db4a4a',
                            borderDash: [5, 5],
                            tension: 0.1
                        } */
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'x',
                        intersect: false,
                        axis: 'x'
                    }, plugins: {
                        /* tooltip: {
                            enabled: true,
                            mode: 'x',
                            intersect: false,
                            callbacks: {
                                // Título (por defecto suele ser la fecha/hora)
                                title: function (tooltipItems) {
                                    const fecha = tooltipItems[0].parsed.x;
                                    return `Hora: ${new Date(fecha).toLocaleTimeString()}`;
                                },

                                label: function (tooltipItem) {
                                    const y = tooltipItem.parsed.y;
                                    const xBuscado = new Date(tooltipItem.parsed.x).getTime();

                                    const actividadesFiltradas = actividadesConSatisfaccion.filter(d => {
                                        const inicio = new Date(d.hora_inicio).getTime();
                                        const fin = new Date(d.hora_termino).getTime();
                                        if (tooltipItem.parsed.tipo === 'inicio') {
                                            return inicio === xBuscado;
                                        }
                                        if (tooltipItem.parsed.tipo === 'termino') {
                                            return fin === xBuscado;
                                        }

                                    });

                                    // Eliminar duplicados por id_registro
                                    const actividadesUnicas = Array.from(
                                        new Map(actividadesFiltradas.map(d => [d.id_registro, d])).values()
                                    );



                                    const claves = actividadesUnicas.map(d =>
                                        d.nombre_actividad?.trim() ||
                                        d.nombre_subcategoria?.trim() ||
                                        d.nombre_categoria?.trim() ||
                                        d.nombre_dimension?.trim() ||
                                        d.otroValor?.trim() ||
                                        "(sin nombre)"
                                    );



                                    return claves; // <-- retorna array, no string
                                },

                            }
                        } */
                    },

                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'hour',
                                displayFormats: {
                                    hour: 'HH:mm'
                                }
                            },
                            min: minFecha,
                            max: maxFecha,
                            title: { display: true, text: 'Hora' }
                        },
                        y: {
                            min: 0,
                            max: 8,
                            title: { display: true, text: 'Satisfacción' }
                        }
                    }
                }
            });
        }

        /* const ctx = document.getElementById('satisfaccionChart').getContext('2d');


        const fecha1 = new Date('2025-07-11T03:59');
        const fecha2 = new Date('2025-07-12T04:01');
        new Chart(ctx, {
            type: 'line',
            data: {
                datasets: [{
                    label: 'Satisfacción',
                    data: [
                        { x: fecha1, y: 6 },
                        { x: fecha2, y: 7 },

                    ],
                    parsing: false, // importante para usar objetos {x, y}
                    borderColor: '#8b5cf6',
                    tension: 0.3,
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        type: 'time',
                        time: {
                            unit: 'hour',
                            displayFormats: {
                                hour: 'HH:mm'
                            },

                        },
                        min: fecha1,
                        max: fecha2,
                        title: { display: true, text: 'Hora' }
                    },
                    y: {
                        title: { display: true, text: 'Satisfacción' }

                    },

                }
            }
        }); */

    </script>
</body>

</html>